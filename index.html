<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Attendance System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #208090;
            --text: #134252;
            --text-light: #628079;
            --border: rgba(94, 82, 64, 0.2);
            --bg: #fcfcf9;
            --surface: #ffffff;
            --error: #c0152f;
            --success: #2d6a71;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        body {
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 20px;
        }

        h1 {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 14px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .login-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 25px;
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            background: var(--surface);
            color: var(--text);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(32, 128, 144, 0.1);
        }

        button {
            padding: 11px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
            transition: all 200ms;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #1a6573;
        }

        .btn-secondary {
            background: rgba(94, 82, 64, 0.12);
            color: var(--text);
            margin-top: 5px;
            width: 100%;
        }

        .btn-secondary:hover {
            background: rgba(94, 82, 64, 0.2);
        }

        .btn-success {
            background: var(--success);
            color: white;
            width: auto;
            margin-right: 10px;
        }

        .btn-success:hover {
            background: #1f4a50;
        }

        .btn-danger {
            background: var(--error);
            color: white;
            padding: 8px 15px;
            width: auto;
        }

        .btn-danger:hover {
            background: #9b0e26;
        }

        .info-box {
            background: rgba(32, 128, 144, 0.08);
            border-left: 4px solid var(--primary);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            transition: all 200ms;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .header-top h1 {
            margin: 0;
            font-size: 24px;
        }

        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .emp-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 18px;
            transition: all 200ms;
        }

        .emp-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: var(--primary);
        }

        .emp-id {
            font-size: 12px;
            color: var(--text-light);
            font-family: monospace;
            margin-bottom: 8px;
        }

        .emp-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 5px;
        }

        .emp-shift {
            display: inline-block;
            background: rgba(32, 128, 144, 0.1);
            color: var(--primary);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .emp-dept {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 12px;
        }

        .emp-status {
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .status-present {
            background: rgba(45, 106, 113, 0.15);
            color: var(--success);
        }

        .status-absent {
            background: rgba(192, 21, 47, 0.15);
            color: var(--error);
        }

        .emp-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .emp-actions button {
            flex: 1;
            padding: 7px;
            font-size: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 15px;
            font-size: 13px;
        }

        thead {
            background: rgba(32, 128, 144, 0.08);
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: rgba(32, 128, 144, 0.02);
        }

        .message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .message.success {
            background: rgba(45, 106, 113, 0.15);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .message.error {
            background: rgba(192, 21, 47, 0.15);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .emp-dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .emp-welcome {
            background: rgba(32, 128, 144, 0.08);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .emp-welcome p {
            margin: 5px 0;
        }

        .working-hours {
            background: rgba(45, 106, 113, 0.08);
            border: 1px solid var(--success);
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            text-align: center;
        }

        .working-hours h3 {
            color: var(--success);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .working-hours .time-display {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .button-group button {
            flex: 1;
            min-width: 120px;
        }

        @media (max-width: 768px) {
            .login-grid {
                grid-template-columns: 1fr;
            }

            .emp-dashboard {
                grid-template-columns: 1fr;
            }

            .employee-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                gap: 0;
            }

            .tab-btn {
                padding: 10px 12px;
                font-size: 12px;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- LOGIN PAGE -->
        <div id="loginPage" class="page active">
            <header>
                <h1>üè® Hotel Attendance System</h1>
                <p class="subtitle">Login to continue</p>
            </header>

            <div class="login-grid">
                <div class="card">
                    <h2>üîë Admin Login</h2>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="adminPass" placeholder="Enter password">
                    </div>
                    <button class="btn-primary" onclick="adminLogin()">Login as Admin</button>
                </div>

                <div class="card">
                    <h2>üë§ Employee Login</h2>
                    <div class="info-box">
                        <strong>Use Employee ID</strong><br>
                        <small>Example: EMP-5A1K</small>
                    </div>
                    <div class="form-group">
                        <label>Employee ID</label>
                        <input type="text" id="empId" placeholder="EMP-XXXX">
                    </div>
                    <button class="btn-primary" onclick="employeeLogin()">Login as Employee</button>
                </div>
            </div>

            <div id="loginMsg" style="text-align: center; margin-top: 20px;"></div>
        </div>

        <!-- ADMIN PAGE -->
        <div id="adminPage" class="page">
            <div class="header-top">
                <div>
                    <h1>üë®‚Äçüíº Admin Dashboard</h1>
                    <p class="subtitle">Manage employees & attendance</p>
                </div>
                <button class="btn-secondary" onclick="logout()" style="width: 120px;">üö™ Logout</button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchAdminTab('addEmpTab')">‚ûï Add Employee</button>
                <button class="tab-btn" onclick="switchAdminTab('viewEmpTab')">üë• View All Employees</button>
                <button class="tab-btn" onclick="switchAdminTab('markAttTab')">‚úì Mark Attendance</button>
                <button class="tab-btn" onclick="switchAdminTab('reportsTab')">üìä Reports</button>
                <button class="tab-btn" onclick="switchAdminTab('settingsTab')">‚öôÔ∏è Settings</button>
            </div>

            <!-- Add Employee Tab -->
            <div id="addEmpTab" class="tab-content active">
                <div class="card" style="max-width: 500px;">
                    <h2>‚ûï Add New Employee</h2>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="newEmpName" placeholder="Full name">
                    </div>
                    <div class="form-group">
                        <label>Department</label>
                        <select id="newEmpDept">
                            <option value="">Select</option>
                            <option value="Front Office">Front Office</option>
                            <option value="Kitchen">Kitchen</option>
                            <option value="Housekeeping">Housekeeping</option>
                            <option value="Backoffice">Backoffice</option>
                            <option value="Restaurant">Restaurant</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="addEmployee()">+ Add Employee</button>
                </div>
                <div id="addEmpMsg"></div>
            </div>

            <!-- View All Employees Tab -->
            <div id="viewEmpTab" class="tab-content">
                <div id="empListContainer"></div>
            </div>

            <!-- Mark Attendance Tab -->
            <div id="markAttTab" class="tab-content">
                <div class="card" style="max-width: 500px;">
                    <h2>‚úì Mark Attendance</h2>
                    <div class="form-group">
                        <label>Employee</label>
                        <select id="adminMarkEmp">
                            <option value="">Select</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="adminMarkDate">
                    </div>
                    <div class="form-group">
                        <label>Time</label>
                        <input type="time" id="adminMarkTime">
                    </div>
                    <button class="btn-primary" onclick="adminMarkAttendance()">Mark Attendance</button>
                </div>
                <div id="adminMarkMsg"></div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content">
                <div class="button-group">
                    <button class="btn-secondary" onclick="downloadCSV()">üì• Download CSV</button>
                    <button class="btn-secondary" onclick="printReport()">üñ®Ô∏è Print</button>
                    <button class="btn-danger" onclick="clearAllRecords()">üóëÔ∏è Clear All</button>
                </div>
                <div id="reportsList"></div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="card" style="max-width: 500px;">
                    <h2>‚öôÔ∏è Admin Settings</h2>
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" id="currentAdminPass" placeholder="Enter current password">
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newAdminPass" placeholder="Enter new password">
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmAdminPass" placeholder="Confirm new password">
                    </div>
                    <button class="btn-primary" onclick="changeAdminPassword()">Update Password</button>
                </div>
                <div id="settingsMsg"></div>
            </div>
        </div>

        <!-- EMPLOYEE PAGE -->
        <div id="employeePage" class="page">
            <div class="header-top">
                <div>
                    <h1>üë§ Employee Portal</h1>
                    <p class="subtitle">Mark your attendance</p>
                </div>
                <button class="btn-secondary" onclick="logout()" style="width: 120px;">üö™ Logout</button>
            </div>

            <div class="emp-dashboard">
                <!-- Attendance Marking -->
                <div class="card">
                    <h2>üìç Mark Attendance</h2>
                    <div class="emp-welcome">
                        <p id="empName"></p>
                        <p id="empDept"></p>
                        <p id="empShift"></p>
                    </div>

                    <div id="empAttendanceStatus" style="margin-bottom: 15px;"></div>

                    <div class="form-group">
                        <label>Select Shift</label>
                        <select id="empMarkShift">
                            <option value="">Select</option>
                            <option value="Full Night">Full Night</option>
                            <option value="Single">Single</option>
                            <option value="Double">Double</option>
                            <option value="Half Night">Half Night</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="empCapLocation" checked>
                            üìç Capture Location
                        </label>
                    </div>

                    <button class="btn-success" onclick="employeeMarkIn()">‚úì Shift In (Auto Time)</button>
                    <button class="btn-primary" onclick="employeeMarkOut()" id="markOutBtn" style="width: auto; display: none; margin-top: 10px;">üö™ Shift Out (Auto Time)</button>
                    <button class="btn-secondary" onclick="testLocation()" style="display: block; margin-top: 10px;">üìç Test Location</button>
                </div>

                <!-- My Records & Working Hours -->
                <div class="card">
                    <h2>üìã My Attendance</h2>
                    <div id="empMyRecords"></div>
                    <div id="empWorkingHours"></div>
                </div>
            </div>

            <div id="empMsg" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        // ‚≠ê GOOGLE APPS SCRIPT URL - PASTE YOUR DEPLOYMENT URL HERE
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyKARQEAvWf6l1H_In9FxrOVI34g54KgmSy4HDdvMPyCha-TyfZMO_0e4yHyPRrHSWD/exec';

        let ADMIN_PASS = localStorage.getItem('adminPassword') || 'admin123';
        let currentUser = null;

        function loadData() {
            return {
                employees: JSON.parse(localStorage.getItem('employees') || '[]'),
                attendance: JSON.parse(localStorage.getItem('attendance') || '[]')
            };
        }

        async function syncFromGoogleSheet() {
            if (GOOGLE_APPS_SCRIPT_URL.includes('AKfycbx...')) {
                console.warn('‚ö†Ô∏è Google Apps Script URL not configured');
                return;
            }

            try {
                // Fetch employees
                const empResponse = await fetch(GOOGLE_APPS_SCRIPT_URL + '?action=getEmployees');
                const empData = await empResponse.json();
                
                // Fetch attendance
                const attResponse = await fetch(GOOGLE_APPS_SCRIPT_URL + '?action=getAttendance');
                const attData = await attResponse.json();
                
                console.log('üìä Employees:', empData);
                console.log('üìã Attendance:', attData);
                
                // Sync employees
                if (empData.success && empData.employees && Array.isArray(empData.employees)) {
                    const employees = empData.employees.map(e => ({
                        id: e[0] ? String(e[0]).trim() : '',
                        name: e[1] ? String(e[1]).trim() : '',
                        dept: e[2] ? String(e[2]).trim() : ''
                    }));
                    localStorage.setItem('employees', JSON.stringify(employees));
                    console.log('‚úì Employees synced:', employees);
                }
                
                // Sync attendance
                if (attData.success && attData.records && Array.isArray(attData.records)) {
                    const attendance = attData.records.map(a => ({
                        empId: a.empId ? String(a.empId).trim() : '',
                        name: a.name ? String(a.name).trim() : '',
                        dept: a.dept ? String(a.dept).trim() : '',
                        date: a.date ? String(a.date).trim() : '',
                        time: a.checkin ? String(a.checkin).trim() : '',
                        checkout_time: a.checkout ? String(a.checkout).trim() : '',
                        shiftType: a.shiftType || '',
                        category: a.category || '',
                        workingHours: a.workingHours || '',
                        checkoutDate: a.date || '',
                        loc: 'N/A',
                        ts: new Date().toISOString()
                    }));
                    localStorage.setItem('attendance', JSON.stringify(attendance));
                    console.log('‚úì Attendance synced:', attendance);
                }
                
            } catch (e) {
                console.error('‚ùå Sync error:', e);
            }
        }

        function saveData(emp, att) {
            localStorage.setItem('employees', JSON.stringify(emp));
            localStorage.setItem('attendance', JSON.stringify(att));
        }

        function syncEmployeeToSheet(employees) {
            if (GOOGLE_APPS_SCRIPT_URL.includes('AKfycbx...')) {
                console.warn('‚ö†Ô∏è Google Apps Script URL not configured');
                return;
            }

            fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'syncEmployees',
                    employees: employees
                })
            })
            .then(r => r.json())
            .then(d => console.log('‚úì Employees Synced:', d))
            .catch(e => console.error('‚ùå Error:', e));
        }

        function syncAttendanceToSheet(attendance) {
            if (GOOGLE_APPS_SCRIPT_URL.includes('AKfycbx...')) {
                console.warn('‚ö†Ô∏è Google Apps Script URL not configured');
                return;
            }

            const recentAttendance = attendance.slice(-1);
            
            fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'syncAttendance',
                    attendance: recentAttendance
                })
            })
            .then(r => r.json())
            .then(d => console.log('‚úì Attendance Synced:', d))
            .catch(e => console.error('‚ùå Error:', e));
        }

        function getStoredAdminPass() {
            return localStorage.getItem('adminPassword') || 'admin123';
        }

        function setAdminPass(newPass) {
            localStorage.setItem('adminPassword', newPass);
            ADMIN_PASS = newPass;
        }

        function genEmpId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let id = '';
            for (let i = 0; i < 4; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return `EMP-${id}`;
        }

        function calcWorkingHours(checkin, checkout) {
            if (!checkin || !checkout) return '0 hrs 0 min';
            const [inH, inM] = checkin.split(':').map(Number);
            const [outH, outM] = checkout.split(':').map(Number);
            let minutes = (outH * 60 + outM) - (inH * 60 + inM);
            if (minutes < 0) minutes += 24 * 60;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours} hrs ${mins} min`;
        }

        function getShiftType(hours) {
            if (hours >= 7 && hours <= 9) return 'Single (8h)';
            if (hours >= 11 && hours <= 13) return 'One & Half (12h)';
            if (hours >= 15 && hours <= 17) return 'Double (16h)';
            return 'Custom (' + hours + 'h)';
        }

        function getShiftCategory(checkinTime, checkoutTime, checkinDate, checkoutDate) {
            const [inH, inM] = checkinTime.split(':').map(Number);
            const inDateObj = new Date(checkinDate);
            const outDateObj = new Date(checkoutDate);

            if (inH >= 6 && inH < 18) {
                if (outDateObj.getTime() === inDateObj.getTime()) {
                    return 'Day Shift';
                } else {
                    return 'Night Shift';
                }
            }
            if (inH >= 18 || inH < 6) {
                return 'Night Shift';
            }
            return 'Mixed';
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
        }

        function showMsg(text, type, el) {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;
            el.innerHTML = '';
            el.appendChild(msg);
            setTimeout(() => el.innerHTML = '', 4000);
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('#adminPage .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#adminPage .tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
            if (tab === 'viewEmpTab') refreshEmpList();
            if (tab === 'reportsTab') displayReports();
        }

        async function adminLogin() {
            const pass = document.getElementById('adminPass').value;
            const storedPass = getStoredAdminPass();
            if (pass !== storedPass) {
                showMsg('‚ùå Wrong password', 'error', document.getElementById('loginMsg'));
                document.getElementById('adminPass').value = '';
                return;
            }
            
            // Sync from Google Sheet before showing dashboard
            await syncFromGoogleSheet();
            
            currentUser = { type: 'admin' };
            document.getElementById('adminMarkDate').valueAsDate = new Date();
            document.getElementById('adminPass').value = '';
            refreshAdminUI();
            showPage('adminPage');
        }

        function changeAdminPassword() {
            const currentPass = document.getElementById('currentAdminPass').value;
            const newPass = document.getElementById('newAdminPass').value;
            const confirmPass = document.getElementById('confirmAdminPass').value;

            if (!currentPass || !newPass || !confirmPass) {
                showMsg('‚ùå Fill all fields', 'error', document.getElementById('settingsMsg'));
                return;
            }

            const storedPass = getStoredAdminPass();
            if (currentPass !== storedPass) {
                showMsg('‚ùå Current password is incorrect', 'error', document.getElementById('settingsMsg'));
                return;
            }

            if (newPass !== confirmPass) {
                showMsg('‚ùå New passwords do not match', 'error', document.getElementById('settingsMsg'));
                return;
            }

            if (newPass.length < 4) {
                showMsg('‚ùå Password must be at least 4 characters', 'error', document.getElementById('settingsMsg'));
                return;
            }

            setAdminPass(newPass);
            document.getElementById('currentAdminPass').value = '';
            document.getElementById('newAdminPass').value = '';
            document.getElementById('confirmAdminPass').value = '';
            showMsg('‚úì Password changed successfully!', 'success', document.getElementById('settingsMsg'));
        }

        function refreshAdminUI() {
            const { employees } = loadData();
            const sel = document.getElementById('adminMarkEmp');
            sel.innerHTML = '<option value="">Select</option>';
            employees.forEach(e => {
                sel.innerHTML += `<option value="${e.id}">${e.name} (${e.id})</option>`;
            });
        }

        function refreshEmpList() {
            const { employees, attendance } = loadData();
            if (employees.length === 0) {
                document.getElementById('empListContainer').innerHTML = '<p style="text-align:center; color: var(--text-light); padding: 30px;">No employees yet</p>';
                return;
            }

            let html = '<div class="employee-grid">';
            employees.forEach(e => {
                const todayAtt = attendance.find(a => a.empId === e.id && a.date === new Date().toISOString().split('T')[0]);
                const status = todayAtt ? (todayAtt.checkout_time ? '‚úì Completed' : '‚è±Ô∏è In Progress') : '‚ùå Absent';
                const statusClass = todayAtt ? (todayAtt.checkout_time ? 'status-present' : 'status-present') : 'status-absent';
                let shiftInfo = 'N/A';
                let workingHours = 'N/A';
                if (todayAtt && todayAtt.checkout_time) {
                    const hoursWorked = calcWorkingHours(todayAtt.time, todayAtt.checkout_time);
                    const hours = parseInt(hoursWorked);
                    const shiftType = getShiftType(hours);
                    const shiftCat = getShiftCategory(todayAtt.time, todayAtt.checkout_time, todayAtt.date, todayAtt.checkoutDate || todayAtt.date);
                    shiftInfo = `${shiftType} (${shiftCat})`;
                    workingHours = hoursWorked;
                }
                html += `
                    <div class="emp-card">
                        <div class="emp-id">${e.id}</div>
                        <div class="emp-name">${e.name}</div>
                        <div class="emp-shift">${shiftInfo}</div>
                        <div class="emp-dept">üìå ${e.dept}</div>
                        <div class="emp-status ${statusClass}">${status}</div>
                        <div style="font-size: 12px; color: var(--text-light); margin-bottom: 10px;">
                            <strong>Working Hours:</strong> ${workingHours}
                        </div>
                        ${todayAtt ? `
                            <div style="font-size: 11px; color: var(--text-light); margin-bottom: 10px;">
                                Check-in: ${todayAtt.time}<br>
                                ${todayAtt.checkout_time ? `Check-out: ${todayAtt.checkout_time}` : 'Check-out: Pending'}
                            </div>
                        ` : ''}
                        <div class="emp-actions">
                            <button class="btn-secondary" style="width: 48%; padding: 7px; font-size: 12px;" onclick="editEmp('${e.id}')">‚úèÔ∏è Edit</button>
                            <button class="btn-danger" style="width: 48%; padding: 7px; font-size: 12px;" onclick="delEmp('${e.id}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('empListContainer').innerHTML = html;
        }

        function addEmployee() {
            const name = document.getElementById('newEmpName').value.trim();
            const dept = document.getElementById('newEmpDept').value;

            if (!name || !dept) {
                alert('Fill all fields');
                return;
            }

            const { employees, attendance } = loadData();
            const id = genEmpId();
            employees.push({ id, name, dept });
            
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('attendance', JSON.stringify(attendance));
            syncEmployeeToSheet(employees);

            document.getElementById('newEmpName').value = '';
            document.getElementById('newEmpDept').value = '';

            showMsg(`‚úì Employee ${name} (${id}) added!`, 'success', document.getElementById('addEmpMsg'));
            refreshAdminUI();
        }

        function editEmp(id) {
            const { employees, attendance } = loadData();
            const emp = employees.find(e => e.id === id);
            if (!emp) return;

            const newName = prompt('Enter new name:', emp.name);
            if (newName === null) return;
            if (!newName.trim()) {
                alert('Name cannot be empty');
                return;
            }

            const newDept = prompt('Select department:\n1. Front Office\n2. Kitchen\n3. Housekeeping\n4. Backoffice\n5. Restaurant', emp.dept);
            if (newDept === null) return;

            const validDepts = ['Front Office', 'Kitchen', 'Housekeeping', 'Backoffice', 'Restaurant'];
            if (!validDepts.includes(newDept)) {
                alert('Invalid department');
                return;
            }

            const empIdx = employees.findIndex(e => e.id === id);
            if (empIdx !== -1) {
                employees[empIdx].name = newName.trim();
                employees[empIdx].dept = newDept;
                localStorage.setItem('employees', JSON.stringify(employees));
                localStorage.setItem('attendance', JSON.stringify(attendance));
                syncEmployeeToSheet(employees);
                refreshEmpList();
                alert('‚úì Employee updated!');
            }
        }

        function delEmp(id) {
            if (!confirm('Delete this employee?')) return;
            let { employees, attendance } = loadData();
            employees = employees.filter(e => e.id !== id);
            attendance = attendance.filter(a => a.empId !== id);
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('attendance', JSON.stringify(attendance));
            syncEmployeeToSheet(employees);
            refreshEmpList();
        }

        function adminMarkAttendance() {
            const empId = document.getElementById('adminMarkEmp').value;
            const date = document.getElementById('adminMarkDate').value;
            const time = document.getElementById('adminMarkTime').value;

            if (!empId || !date || !time) {
                alert('Fill all fields');
                return;
            }

            const { employees, attendance } = loadData();
            const emp = employees.find(e => e.id === empId);
            if (!emp) return;

            attendance.push({
                empId, name: emp.name, dept: emp.dept,
                date, time, checkout_time: null, checkoutDate: null, loc: 'N/A', ts: new Date().toISOString()
            });
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('attendance', JSON.stringify(attendance));
            syncAttendanceToSheet(attendance);

            showMsg('‚úì Attendance marked!', 'success', document.getElementById('adminMarkMsg'));
            refreshAdminUI();
        }

        function displayReports() {
            const { attendance } = loadData();
            if (attendance.length === 0) {
                document.getElementById('reportsList').innerHTML = '<p style="text-align:center; color: var(--text-light); padding: 30px;">No records yet</p>';
                return;
            }

            let html = '<table><thead><tr><th>EmpID</th><th>Name</th><th>Department</th><th>Date</th><th>Check-in</th><th>Check-out</th><th>Shift Type</th><th>Shift Category</th><th>Working Hours</th></tr></thead><tbody>';
            attendance.forEach(a => {
                let shiftType = 'N/A', shiftCat = 'N/A', workHours = 'N/A';
                if (a.checkout_time) {
                    const hourStr = calcWorkingHours(a.time, a.checkout_time);
                    const hours = parseInt(hourStr);
                    workHours = hourStr;
                    shiftType = getShiftType(hours);
                    shiftCat = getShiftCategory(a.time, a.checkout_time, a.date, a.checkoutDate || a.date);
                }
                html += `<tr><td>${a.empId}</td><td>${a.name}</td><td>${a.dept}</td><td>${a.date}</td><td>${a.time}</td><td>${a.checkout_time || 'Pending'}</td><td>${shiftType}</td><td>${shiftCat}</td><td>${workHours}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('reportsList').innerHTML = html;
        }

        function downloadCSV() {
            const { attendance } = loadData();
            if (attendance.length === 0) {
                alert('No records');
                return;
            }
            let csv = 'EmpID,Name,Department,Date,CheckIn,CheckOut,ShiftType,ShiftCategory,WorkingHours\n';
            attendance.forEach(a => {
                let shiftType = 'N/A', shiftCat = 'N/A', hours = 'N/A';
                if (a.checkout_time) {
                    const hourStr = calcWorkingHours(a.time, a.checkout_time);
                    hours = hourStr;
                    shiftType = getShiftType(parseInt(hourStr));
                    shiftCat = getShiftCategory(a.time, a.checkout_time, a.date, a.checkoutDate || a.date);
                }
                csv += `"${a.empId}","${a.name}","${a.dept}","${a.date}","${a.time}","${a.checkout_time || 'Pending'}","${shiftType}","${shiftCat}","${hours}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `attendance_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function printReport() {
            const { attendance } = loadData();
            if (attendance.length === 0) {
                alert('No records');
                return;
            }
            let html = '<html><head><style>body{font-family:Arial}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:8px}th{background:#208090;color:white}</style></head><body><h1>Attendance Report</h1><p>Generated: ' + new Date().toLocaleString() + '</p><table><thead><tr><th>EmpID</th><th>Name</th><th>Department</th><th>Date</th><th>Check-in</th><th>Check-out</th><th>Shift Type</th><th>Category</th><th>Hours</th></tr></thead><tbody>';
            attendance.forEach(a => {
                let shiftType = 'N/A', shiftCat = 'N/A', hours = 'N/A';
                if (a.checkout_time) {
                    const hourStr = calcWorkingHours(a.time, a.checkout_time);
                    hours = hourStr;
                    shiftType = getShiftType(parseInt(hourStr));
                    shiftCat = getShiftCategory(a.time, a.checkout_time, a.date, a.checkoutDate || a.date);
                }
                html += `<tr><td>${a.empId}</td><td>${a.name}</td><td>${a.dept}</td><td>${a.date}</td><td>${a.time}</td><td>${a.checkout_time || 'Pending'}</td><td>${shiftType}</td><td>${shiftCat}</td><td>${hours}</td></tr>`;
            });
            html += '</tbody></table></body></html>';
            const w = window.open('', '', 'width=800,height=600');
            w.document.write(html);
            w.print();
        }

        function clearAllRecords() {
            const confirmClear = confirm('‚ö†Ô∏è Clear all attendance records from localStorage?\n\n(Google Sheet data will remain intact)');
            if (!confirmClear) return;

            const { employees } = loadData();
            localStorage.setItem('attendance', JSON.stringify([]));
            
            showMsg('‚úì All records cleared from localStorage!', 'success', document.getElementById('reportsList'));
            setTimeout(() => displayReports(), 500);
        }

        async function employeeLogin() {
            // Sync from Google Sheet before checking employee
            await syncFromGoogleSheet();
            
            const id = document.getElementById('empId').value.trim().toUpperCase();
            const { employees } = loadData();
            const emp = employees.find(e => e.id.toUpperCase() === id);

            if (!emp) {
                showMsg('‚ùå ID not found. Admin needs to create your ID first.', 'error', document.getElementById('loginMsg'));
                document.getElementById('empId').value = '';
                return;
            }

            currentUser = { type: 'employee', id: emp.id, name: emp.name, dept: emp.dept };
            document.getElementById('empId').value = '';
            refreshEmployeeUI();
            showPage('employeePage');
        }

        function refreshEmployeeUI() {
            document.getElementById('empName').innerHTML = `<strong>Name:</strong> ${currentUser.name}`;
            document.getElementById('empDept').innerHTML = `<strong>Dept:</strong> ${currentUser.dept}`;
            document.getElementById('empShift').innerHTML = '';

            const { attendance } = loadData();
            const today = new Date().toISOString().split('T')[0];
            const todayAtt = attendance.find(a => a.empId === currentUser.id && a.date === today);

            let statusHtml = '';
            if (todayAtt) {
                if (todayAtt.checkout_time) {
                    statusHtml = '<div class="emp-status status-present">‚úì Shift Completed</div>';
                } else {
                    statusHtml = '<div class="emp-status status-present">‚è±Ô∏è Shift In Progress</div>';
                }
            } else {
                statusHtml = '<div class="emp-status status-absent">‚ùå Not Marked</div>';
            }
            document.getElementById('empAttendanceStatus').innerHTML = statusHtml;

            const markOutBtn = document.getElementById('markOutBtn');
            if (todayAtt && !todayAtt.checkout_time) {
                markOutBtn.style.display = 'inline-block';
            } else {
                markOutBtn.style.display = 'none';
            }

            const myAtt = attendance.filter(a => a.empId === currentUser.id);
            if (myAtt.length === 0) {
                document.getElementById('empMyRecords').innerHTML = '<p style="color: var(--text-light);">No records yet</p>';
                document.getElementById('empWorkingHours').innerHTML = '';
            } else {
                let tbl = '<table><thead><tr><th>Date</th><th>Check-in</th><th>Check-out</th><th>Shift Type</th><th>Category</th><th>Hours</th></tr></thead><tbody>';
                myAtt.forEach(a => {
                    let shiftType = 'N/A', shiftCat = 'N/A', hours = 'In Progress';
                    if (a.checkout_time) {
                        const hourStr = calcWorkingHours(a.time, a.checkout_time);
                        hours = hourStr;
                        shiftType = getShiftType(parseInt(hourStr));
                        shiftCat = getShiftCategory(a.time, a.checkout_time, a.date, a.checkoutDate || a.date);
                    }
                    tbl += `<tr><td>${a.date}</td><td>${a.time}</td><td>${a.checkout_time || 'Pending'}</td><td>${shiftType}</td><td>${shiftCat}</td><td><strong>${hours}</strong></td></tr>`;
                });
                tbl += '</tbody></table>';
                document.getElementById('empMyRecords').innerHTML = tbl;

                if (todayAtt && todayAtt.checkout_time) {
                    const todayHours = calcWorkingHours(todayAtt.time, todayAtt.checkout_time);
                    const hours = parseInt(todayHours);
                    const shiftType = getShiftType(hours);
                    const shiftCat = getShiftCategory(todayAtt.time, todayAtt.checkout_time, todayAtt.date, todayAtt.checkoutDate || todayAtt.date);
                    document.getElementById('empWorkingHours').innerHTML = `
                        <div class="working-hours">
                            <h3>Today's Summary</h3>
                            <p><strong>Check-in:</strong> ${todayAtt.time}</p>
                            <p><strong>Check-out:</strong> ${todayAtt.checkout_time}</p>
                            <p><strong>Shift Type:</strong> ${shiftType}</p>
                            <p><strong>Category:</strong> ${shiftCat}</p>
                            <div class="time-display">${todayHours}</div>
                        </div>
                    `;
                }
            }
        }

        function employeeMarkIn() {
            const today = new Date().toISOString().split('T')[0];
            const { employees, attendance } = loadData();
            const alreadyMarked = attendance.find(a => a.empId === currentUser.id && a.date === today);

            if (alreadyMarked) {
                alert('Already marked for today');
                return;
            }

            const now = new Date();
            const time = now.toTimeString().slice(0, 5);
            let loc = 'N/A';

            if (document.getElementById('empCapLocation').checked) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        loc = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
                        saveEmpMarkIn(today, time, loc);
                    },
                    () => saveEmpMarkIn(today, time, loc),
                    { enableHighAccuracy: true, timeout: 15000 }
                );
            } else {
                saveEmpMarkIn(today, time, loc);
            }
        }

        function saveEmpMarkIn(date, time, loc) {
            const { employees, attendance } = loadData();
            attendance.push({
                empId: currentUser.id, name: currentUser.name, dept: currentUser.dept,
                date, time, checkout_time: null, checkoutDate: null, loc, ts: new Date().toISOString()
            });
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('attendance', JSON.stringify(attendance));
            syncAttendanceToSheet(attendance);
            showMsg('‚úì Shift In marked! Time: ' + time, 'success', document.getElementById('empMsg'));
            refreshEmployeeUI();
        }

        function employeeMarkOut() {
            const today = new Date().toISOString().split('T')[0];
            const { employees, attendance } = loadData();
            const todayAtt = attendance.find(a => a.empId === currentUser.id && a.date === today);

            if (!todayAtt) {
                alert('No check-in for today');
                return;
            }

            if (todayAtt.checkout_time) {
                alert('Already marked checkout');
                return;
            }

            const now = new Date();
            const checkoutTime = now.toTimeString().slice(0, 5);

            if (document.getElementById('empCapLocation').checked) {
                navigator.geolocation.getCurrentPosition(
                    pos => saveEmpMarkOut(todayAtt, checkoutTime),
                    () => saveEmpMarkOut(todayAtt, checkoutTime),
                    { enableHighAccuracy: true, timeout: 15000 }
                );
            } else {
                saveEmpMarkOut(todayAtt, checkoutTime);
            }
        }

        function saveEmpMarkOut(att, checkoutTime) {
            const { employees, attendance } = loadData();
            const idx = attendance.findIndex(a => 
                a.empId === att.empId && 
                a.date === att.date && 
                a.time === att.time &&
                !a.checkout_time
            );
            if (idx !== -1) {
                attendance[idx].checkout_time = checkoutTime;
                localStorage.setItem('employees', JSON.stringify(employees));
                localStorage.setItem('attendance', JSON.stringify(attendance));
                syncAttendanceToSheet(attendance);
                const hours = calcWorkingHours(att.time, checkoutTime);
                showMsg(`‚úì Shift Out marked! Working Hours: ${hours}`, 'success', document.getElementById('empMsg'));
                setTimeout(() => refreshEmployeeUI(), 100);
            }
        }

        function testLocation() {
            navigator.geolocation.getCurrentPosition(
                pos => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lng = pos.coords.longitude.toFixed(6);
                    showMsg(`‚úì Location: ${lat}, ${lng}`, 'success', document.getElementById('empMsg'));
                },
                err => showMsg(`‚ùå ${err.message}`, 'error', document.getElementById('empMsg')),
                { enableHighAccuracy: true, timeout: 15000 }
            );
        }

        function logout() {
            currentUser = null;
            document.getElementById('adminPass').value = '';
            document.getElementById('empId').value = '';
            document.getElementById('loginMsg').innerHTML = '';
            showPage('loginPage');
        }

        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const qrEmp = params.get('empId');
            if (qrEmp) document.getElementById('empId').value = qrEmp;
            
            // Sync from Google Sheet on page load
            syncFromGoogleSheet();
        });
    </script>
</body>
</html>
